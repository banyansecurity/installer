#!/bin/bash

set -euo pipefail

cd "${BASH_SOURCE[0]%/*}"

# packages.env is generated by RPM on install
source ./packages.env

BANYAN_API=${BANYAN_API:-https://net.banyanops.com/api/v1}
CONFIG_TPL=config.yaml.tpl
DEPS="jq tar gzip curl sed"

INSTALL_CMD=$(which apt || which yum)
if [[ $(which dpkg) ]]; then
	SEARCH_CMD="dpkg -s"
elif [[ $(which rpm) ]]; then
	SEARCH_CMD="rpm -q --quiet"
fi

if [[ $# -lt 1 || "$1" == "-h" ]]; then
  echo "Usage: `basename $0` [refresh-token] [cluster-name]"
  echo
  echo "Your refresh-token is available from the Banyan console in the 'My Profile' section."
  exit 1
fi

MISSING_DEPS=()
for x in ${DEPS}; do
   ${SEARCH_CMD} ${x} &> /dev/null || [[ -x "$(command -v ${x})" ]] || MISSING_DEPS+=(${x})
done
[[ -z "${MISSING_DEPS[@]:-}" ]] || ${INSTALL_CMD} install -y ${MISSING_DEPS[@]}

RTOKEN=${1?RefreshToken Required}
CLUSTER_NAME=${2?ClusterName Required}

tar -xzf ${NETAGENT_PACKAGE} && cd ${NETAGENT_PACKAGE%%.tar.gz}

# Exchange refresh token for an access token
ATOKEN=$(curl -sf -XPOST -H "Authorization: Bearer ${RTOKEN}" ${BANYAN_API}/refresh_token |jq -r .Message)

# Exit with distinct code 64 if ATOKEN is not set
[[ -z "${ATOKEN}" ]] && echo "Failed to get AccessToken" && exit 64

AUTH="Authorization: Bearer ${ATOKEN}"
ORG_NAME=$(curl -sf -H "${AUTH}" ${BANYAN_API}/user_org_details |jq -r .OrgName)
OTK=$(curl -sf -H "${AUTH}" ${BANYAN_API}/one_time_security_key?clustername=${CLUSTER_NAME} |jq -r .OneTimeKey)
SHIELD_ADDR=$(curl -sf -H "${AUTH}" ${BANYAN_API}/one_time_security_key?clustername=${CLUSTER_NAME} |jq -r .PublicAddr)

# Check for CONFIG_TPL in parent dir
[[ -f "../${CONFIG_TPL}" ]] && cp ../${CONFIG_TPL} ./

../configure-netagent \
  --gpg-password=gobany@n \
  --shield-address=${SHIELD_ADDR} \
  --one-time-key=${OTK} \
  ${CONFIG_TPL} > config.yaml

# Setup and start
bash ./setup-netagent.sh
